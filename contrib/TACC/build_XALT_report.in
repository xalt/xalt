#!/bin/bash
# -*- shell-script -*-

MCLAY=~mclay
export PATH=$MCLAY/l/pkg/xalt/xalt/bin:$MCLAY/l/pkg/xalt/xalt/sbin:$PATH
WD=$MCLAY/xalt_usage/
M=$WD/m
LOG_DIR=/var/log

########################################################################
# Build host list on this VM and store startdate
declare -A startDateT
syshostA=()
CWD=$PWD
cd $M
for i in *; do
  syshostA+=($i)
  . $i/.startDate.sh
  startDateT[$i]=$startDate
done
cd $CWD

today=$(date +%F)
last30=$(date -d "-30days" +%F)

if [ "$1" = "--mail" ]; then
   sendTo="$2"
fi

cd $MCLAY/xalt_usage

for i in "${syshostA[@]}"; do
   XALT_START_DATE="${startDateT[$i]}"
   xalt_start_s=$(date -d $XALT_START_DATE +%s)

   last365=$(date -d "-365days" +%F)
   last365s=$(date -d "-365days" +%s)

   if [ "$xalt_start_s" -gt "$last365s" ]; then
     last365=$(date -d $XALT_START_DATE +%F)
   fi


   fn30="XALT-Report-${i}-last30-$today.txt"
   fn365="XALT-Report-${i}-last365-$today.txt"

   mkdir -p $i/last30
   mkdir -p $i/last365

   python ./xalt_usage_report.py --confFn m/$i/xalt_${i}_db.conf --syshost $i --start $last30  --end $today > $i/last30/$fn30
   python ./xalt_usage_report.py --confFn m/$i/xalt_${i}_db.conf --syshost $i --start $last365 --end $today > $i/last365/$fn365

done

if [ -n "$sendTo" ]; then
   rm -rf ./xalt_rpts
   mkdir ./xalt_rpts
   for i in "${syshostA[@]}"; do
       fn30="XALT-Report-${i}-last30-$today.txt"
       fn365="XALT-Report-${i}-last365-$today.txt"
       for fn in $i/last30/$fn30 $i/last365/$fn365; do
          if [ -f $fn ]; then
	     cp $fn ./xalt_rpts
          fi
       done
   done
   cd ./xalt_rpts
   zip ../xalt_rpts_$today.zip *
   cd ..
   echo "XALT Reports for $today" | mail -s "XALT Reports for $today in a zip file" -a xalt_rpts_$today.zip $sendTo
   sleep 10
   rm ./xalt_rpts_$today.zip
fi
